#!/bin/env bash
#+ Run DNS and DHCP servers on qvm0 interface.
#+ Usage: SCRIPT [-n] [-t] [-d] [-f] [up | down]
set -eu
SCRIPT="$(basename "$0")"
DIR="$(dirname "$0")"
source "${DIR}/libqvm.sh"

#+ Options:
#+ -h  Print this message
#+ -n  Dry run: print commands that would be executed
dry_run=0
#+ -t  Test: perform a syntax check on the configuration
test=0
#+ -c  Configuration file for dnsmasq
#+     Default: net/dnsmasq.conf in this repository
conf="${DIR}/net/dnsmasq.conf"
#+ -d  Debug mode
debug=0
#+ -f  Foreground execution of dnsmasq
fg=0

while getopts tndfhc: opt; do
  case "${opt}" in
    t)
      test=1 ;;
    n)
      dry_run=1 ;;
    d)
      debug=1 ;;
    f)
      fg=1 ;;
    c)
      conf="${OPTARG}" ;;
    *)
      usage "${opt}" ;;
  esac
done
shift $((OPTIND - 1))

action="${1:-up}"
pid_file="${QVM_DIR:-/var/vms}/run/dnsmasq.pid"
pcap_file="${QVM_DIR:-/var/vms}/run/dnsmasq.pcap"

trap cleanup EXIT

cleanup() {
  ((fg | debug)) || rm -f "${pid_file}"
}

down() {
  local pid
  if ! [[ -f "${pid_file}" ]]; then
    errexit "dnsmasq does not seem to be running"
  fi
  pid="$(cat "${pid_file:-/dev/null}")"
  if ! run sudo kill "${pid}"; then
    errexit "Unable to stop dnsmasq (${pid}). Stale pid ?"
  fi
}

up() {
  declare -a args=(
    --conf-file="${conf}" "$@"
  )

  if ((test)); then
    args+=(--test)
  fi

  if ((debug)); then
    args+=(
      --no-daemon
      --dumpfile="${pcap_file}"
      # DHCP query/reply
      # DNS query/reply
      --dumpmask=$((0x1000|0x0002|0x0002))
    )
  elif ((fg)); then
    args+=("--keep-in-foreground")
  else
    args+=(
      --pid-file="${pid_file}"
    )
  fi
  run sudo dnsmasq "${args[@]}"
}

case "${action}" in
  up|down) "${action}" ;;
  *) usage ;;
esac
